<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç¯‰æ¤œå®š</title>
    <link rel="icon" href="/favicon.ico" type="image/svg+xml">
    <!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning in console
        tailwind.config = { corePlugins: { preflight: true } };
    </script>
    <!-- jsPDF (PDFåˆæ ¼è¨¼ã®ç”Ÿæˆç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ (æ—¥æœ¬èªPDFç”¨) - jsPDFã¯æ¨™æº–ã§æ—¥æœ¬èªã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ï¼ˆã‚„ã‚„é«˜åº¦ãªå‡¦ç†ï¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }
        /* ç”»é¢ï¼ˆãƒ“ãƒ¥ãƒ¼ï¼‰ã®åˆ‡ã‚Šæ›¿ãˆç”¨ */
        .view {
            display: none; /* åŸºæœ¬ã¯éè¡¨ç¤º */
        }
        .view.active {
            display: block; /* .activeãŒã¤ã„ãŸã‚‰è¡¨ç¤º */
        }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        #loading-overlay.active {
            display: flex; /* activeã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤º */
        }
        /* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            @apply px-4 py-2 rounded-lg text-white font-semibold shadow-md transition-transform transform active:scale-95;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600;
        }
        .btn-green {
            @apply bg-green-600 hover:bg-green-700;
        }
        .btn-red {
            @apply bg-red-600 hover:bg-red-700;
        }
        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
        .option-btn {
            @apply w-full text-left p-3 my-2 border-2 border-gray-300 rounded-lg transition-colors hover:bg-gray-100;
        }
        .option-btn.correct {
            @apply bg-green-100 border-green-500;
        }
        .option-btn.incorrect {
            @apply bg-red-100 border-red-500;
        }
        .option-btn:disabled {
            @apply opacity-70 cursor-not-allowed;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ */
        #timer-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        #timer-bar {
            height: 10px;
            width: 100%; /* 100%ã‹ã‚‰0%ã¸æ¸›ã‚‹ */
            background-color: #4caf50;
            transition: width 0.1s linear; /* ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°ã‚’æ»‘ã‚‰ã‹ã« */
        }
    </style>
</head>
<body>

    <!-- å…¨ç”»é¢ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loading-overlay" class="active">
        <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">å»ºç¯‰æ¤œå®š</div>
            <div class="mt-2 text-gray-700">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰ -->
    <header id="app-header" class="hidden p-4 bg-white shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-xl font-bold text-blue-600">å»ºç¯‰æ¤œå®š</div>
            <div>
                <span id="user-display-name" class="mr-4"></span>
                <button id="logout-button" class="btn btn-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container mx-auto p-4 md:p-8">

        <!-- 1. ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ç”»é¢ -->
        <div id="auth-view" class="view active max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold text-center mb-6">ã‚ˆã†ã“ã</h2>
            
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="login-form">
                <h3 class="text-lg font-semibold mb-3">ãƒ­ã‚°ã‚¤ãƒ³</h3>
                <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-2 border rounded mb-2">
                <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full p-2 border rounded mb-4">
                <button id="login-button" class="btn btn-primary w-full">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <p id="login-error" class="text-red-500 text-sm mt-2"></p>
            </div>

            <div class="text-center my-4 text-gray-500">ã¾ãŸã¯</div>

            <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="register-form">
                <h3 class="text-lg font-semibold mb-3">æ–°è¦ç™»éŒ²</h3>
                <input type="text" id="register-username" placeholder="è¡¨ç¤ºå (åˆæ ¼è¨¼ã«ä½¿ã‚ã‚Œã¾ã™)" class="w-full p-2 border rounded mb-2">
                <input type="email" id="register-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-2 border rounded mb-2">
                <input type="password" id="register-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)" class="w-full p-2 border rounded mb-4">
                <button id="register-button" class="btn btn-green w-full">æ–°è¦ç™»éŒ²</button>
                <p id="register-error" class="text-red-500 text-sm mt-2"></p>
            </div>
        </div>

        <!-- 2. ãƒã‚¤ãƒšãƒ¼ã‚¸ (ç´š é¸æŠç”»é¢) -->
        <div id="mypage-view" class="view max-w-lg mx-auto">
            <h2 class="text-2xl font-bold mb-4">ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <p class="text-lg">ã‚ˆã†ã“ãã€<span id="mypage-username" class="font-bold"></span> ã•ã‚“</p>
                <p class="text-gray-600">ç¾åœ¨ã®æœ€é«˜åˆ°é”ç´š: <span id="mypage-current-level" class="font-bold">N/A</span></p>
            </div>

            <h3 class="text-xl font-semibold mb-3">ç´šã‚’é¸æŠã—ã¦æŒ‘æˆ¦</h3>
            <div id="level-selection" class="grid grid-cols-1 gap-4">
                <!-- ç´šãƒœã‚¿ãƒ³ã¯JSã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                <!-- ä¾‹: <button class="btn btn-primary" data-level="5" disabled>5ç´š (ãƒ­ãƒƒã‚¯ä¸­)</button> -->
            </div>

            <div class="mt-8">
                <button id="goto-ranking-button" class="btn btn-secondary">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</button>
            </div>
        </div>

        <!-- 3. ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quiz-view" class="view max-w-2xl mx-auto">
            <div class="bg-white p-6 rounded-lg shadow-xl">
                <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
                <div class="mb-2">
                    <span id="timer-display" class="font-bold text-lg">æ®‹ã‚Š 30 ç§’</span>
                </div>
                <div id="timer-bar-container" class="mb-4">
                    <div id="timer-bar"></div>
                </div>

                <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="mb-4">
                    <span id="question-counter" class="text-lg font-semibold text-gray-700"></span>
                    <h3 id="question-text" class="text-xl font-bold my-2"></h3>
                    <img id="question-image" src="" alt="å•é¡Œç”»åƒ" class="my-4 rounded-lg max-w-full h-auto hidden">
                </div>

                <!-- é¸æŠè‚¢ -->
                <div id="options-container">
                    <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ã¯JSã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>

                <!-- è§£èª¬ã‚¨ãƒªã‚¢ (å›ç­”å¾Œã«è¡¨ç¤º) -->
                <div id="explanation-container" class="hidden mt-6 pt-4 border-t">
                    <h4 class="text-lg font-bold mb-2">è§£èª¬</h4>
                    <p id="explanation-text"></p>
                    <img id="explanation-image" src="" alt="è§£èª¬ç”»åƒ" class="my-4 rounded-lg max-w-full h-auto hidden">
                    <button id="next-question-button" class="btn btn-primary mt-4 w-full">æ¬¡ã®å•é¡Œã¸</button>
                </div>
            </div>
        </div>

        <!-- 4. çµæœç”»é¢ -->
        <div id="result-view" class="view max-w-md mx-auto text-center">
            <div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold mb-4">çµæœç™ºè¡¨</h2>
                <p class="text-xl mb-2">æŒ‘æˆ¦ã—ãŸç´š: <span id="result-level" class="font-bold"></span></p>
                <p class="text-2xl mb-6">
                    <span id="result-score" class="font-bold text-blue-600">10</span> å•ä¸­ 
                    <span id="result-correct" class="font-bold text-blue-600">0</span> å•æ­£è§£
                </p>

                <div id="result-message-pass" class="hidden">
                    <p class="text-xl font-semibold text-green-600 mb-4">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼åˆæ ¼ã§ã™ï¼</p>
                    <button id="certificate-button" class="btn btn-green mb-4 w-full">åˆæ ¼è¨¼ã‚’ç™ºè¡Œã™ã‚‹</button>
                </div>
                
                <div id="result-message-fail" class="hidden">
                    <p class="text-lg text-red-600 mb-4">æ®‹å¿µãªãŒã‚‰ä¸åˆæ ¼ã§ã™ã€‚åˆæ ¼ãƒ©ã‚¤ãƒ³ã¯8å•æ­£è§£ã§ã™ã€‚</p>
                    <button id="retry-quiz-button" class="btn btn-primary mb-4 w-full">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
                </div>

                <button id="back-to-mypage-button" class="btn btn-secondary w-full">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- 5. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
        <div id="ranking-view" class="view max-w-lg mx-auto">
            <h2 class="text-2xl font-bold mb-4">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <p class="text-gray-600 mb-4">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€é«˜åˆ°é”ç´šã¨ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ã§é›†è¨ˆã—ã¦ã„ã¾ã™ã€‚</p>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left p-2">é †ä½</th>
                            <th class="text-left p-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                            <th class="text-left p-2">æœ€é«˜åˆ°é”ç´š</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body">
                        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯JSã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                        <tr><td colspan="3" class="text-center p-4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            <button id="ranking-back-button" class="btn btn-secondary mt-6">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
        </div>

    </main>

    <!-- Firebase SDK (9ç³» - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å½¢å¼) -->
    <!-- ã“ã‚Œã‚‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚³ãƒ”ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ -->
    <script type="module">
        // Firebase SDK ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            updateProfile,
            onAuthStateChanged, 
            signOut,
            connectAuthEmulator
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            addDoc,
            query,
            getDocs,
            orderBy, // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨
            where,
            connectFirestoreEmulator,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebaseã®åˆæœŸåŒ–
        let app, auth, db;
        let useEmulators = false; // ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ä½¿ç”¨ãƒ•ãƒ©ã‚°
        
        (async function initializeFirebase() {
            try {
                console.log("Initializing Firebase...");
                // Vercelã®APIã‹ã‚‰Firebaseè¨­å®šã‚’å–å¾—ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰ä¾›çµ¦ï¼‰
                const res = await fetch('/api/firebase-config');
                if (!res.ok) {
                    throw new Error('Failed to load firebase config.');
                }
                const firebaseConfig = await res.json();
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    alert('Firebaseè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Vercelã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                    throw new Error('Missing firebase config');
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase initialized successfully.");
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            // ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆè¤‡æ•°ã‚¿ãƒ–ç«¶åˆã‚’å›é¿ï¼‰
            /*
            try {
                await enableIndexedDbPersistence(db);
                console.log("âœ… Firestore offline persistence enabled");
            } catch (err) {
                if (err.code === 'failed-precondition') {
                    console.warn("âš ï¸ Multiple tabs open, persistence only enabled in first tab");
                } else if (err.code === 'unimplemented') {
                    console.warn("âš ï¸ Browser doesn't support persistence");
                } else {
                    console.warn("âš ï¸ Persistence error:", err);
                }
            }
            */
            
            // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æ¥ç¶šï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆ¶å¾¡å¯èƒ½ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const forceEmulator = urlParams.get('emulator') === 'true';
            
            if (forceEmulator && (location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
                try {
                    connectAuthEmulator(auth, 'http://127.0.0.1:9099', { disableWarnings: true });
                    connectFirestoreEmulator(db, '127.0.0.1', 8080);
                    useEmulators = true;
                    console.log('âœ… Connected to Firebase Emulators (Auth:9099, Firestore:8080).');
                    console.log('ğŸ’¡ Using LOCAL emulator data (not production)');
                } catch (e) {
                    console.warn('âš ï¸ Failed to connect emulators (using production instead):', e.message);
                }
            } else if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                console.log('ğŸ’¡ Running on localhost but using PRODUCTION Firebase.');
                console.log('ğŸ’¡ To use emulators, add ?emulator=true to URL');
                console.log('ğŸ” Checking Firestore connection...');
                
                // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                setTimeout(async () => {
                    try {
                        const testDoc = await getDoc(doc(db, '_test', 'connection'));
                        console.log('âœ… Firestore connection successful');
                    } catch (err) {
                        console.error('âŒ Firestore connection failed:', err);
                        console.error('ğŸ“‹ Please check:');
                        console.error('  1. Firebase Console > Firestore Database is created');
                        console.error('  2. Firestore Rules allow read/write');
                        console.error('  3. No browser extensions blocking requests');
                        console.error('  4. Network/firewall not blocking firestore.googleapis.com');
                    }
                }, 2000);
            }

            // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ï¼ˆåˆæœŸåŒ–å¾Œã«ç™»éŒ²ï¼‰
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("âœ… User logged in:", user.email || user.uid);
                    currentUser = user;
                    await fetchUserData(user.uid, user.displayName);
                    setupMypage();
                    showView('mypage-view');
                    document.getElementById('user-display-name').textContent = userData.username;
                } else {
                    console.log("â„¹ï¸ No user logged in");
                    currentUser = null;
                    userData = { username: "", clearedLevels: [], maxLevel: 5 };
                    showView('auth-view');
                }
                showLoading(false);
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // åˆæœŸåŒ–å¤±æ•—æ™‚ã‚‚èªè¨¼ç”»é¢ã‚’è¡¨ç¤º
            showView('auth-view');
            showLoading(false);
        }
        })(); // å³åº§ã«å®Ÿè¡Œ
        
        // ---------------------------------------------------------------------
        // å•é¡Œãƒ‡ãƒ¼ã‚¿ (CSVã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«)
        // æœ¬æ¥ã¯ã€ã“ã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã¯Firebase Firestoreã«ä¿å­˜ã—ã€
        // ç´š(level)ã«å¿œã˜ã¦APIçµŒç”±ã§å–å¾—ã—ã¾ã™ã€‚(ã‚¹ãƒ†ãƒƒãƒ—8ã§è§£èª¬)
        // ---------------------------------------------------------------------
        const quizDataStore = {
            // 5ç´šã®å•é¡Œ (gid=6)
            "5": [
                {
                    id: 1,
                    level: 5,
                    title: "æ§‹é€ ",
                    image: "https://placehold.co/400x200?text=5-1-1-Q.png", // ç”»åƒãƒ‘ã‚¹ã¯ãƒ€ãƒŸãƒ¼ã§ã™
                    question: "1å€‹ 100gã®ãƒ‹ãƒ³ãƒ†ãƒ³ãƒ‰ãƒ¼3DSã®æ–°å“ã‚’4æœ¬è„šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸­å¿ƒã«8å€‹ç½®ãã¾ã—ãŸã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®è„šã®1cmÂ²å½“ãŸã‚Šã®æ”¯ãˆã‚‹é‡ã•ã‚’æ¬¡ã®4ã¤ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ­£æ–¹å½¢ã§ã™ã€‚è„šã®å¤ªã•ã¯10cmÃ—10cmã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®4éš…ã«ã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®é‡ã•ã¯ 0 ã§ã™ã€‚",
                    options: ["0.02g/cmÂ²", "0.2g/cmÂ²", "2g/cmÂ²", "20g/cmÂ²"],
                    answer: 2, // 0-indexed (3ç•ªç›®)
                    explainImage: "https://placehold.co/400x200?text=5-1-1-A.png", // ç”»åƒãƒ‘ã‚¹ã¯ãƒ€ãƒŸãƒ¼ã§ã™
                    explanation: "ãƒ‹ãƒ³ãƒ†ãƒ³ãƒ‰ãƒ¼3DSãŒãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸­å¿ƒã«ä¹—ã£ã¦ã„ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®è„šã¯4æœ¬ã§ã€è„šã¾ã§ã®è·é›¢ãŒåŒã˜ã§ã™ã®ã§ã€è„šã®æ”¯ãˆã‚‹é‡ã•ã¯4ç­‰åˆ†ã«ãªã‚Šã¾ã™ã€‚\nå…¨ä½“ã®é‡ã• 100*8ï¼800g\nè„š1æœ¬ã®è² æ‹…ã™ã‚‹é‡ã•ã€‚ 800Ã·4ï¼200g\nãã—ã¦ã€è„šã®é¢ç©ã¯ 10Ã—10ï¼100cmÂ² ã§ã™ã®ã§ã€ 200gÃ·100cmÂ²ï¼2g/cmÂ² ã¨ãªã‚Šã¾ã™ã€‚"
                },
                {
                    id: 2,
                    level: 5,
                    title: "æ§‹é€ ",
                    image: "https://placehold.co/400x200?text=5-1-2-Q.png", // ç”»åƒãƒ‘ã‚¹ã¯ãƒ€ãƒŸãƒ¼ã§ã™
                    question: "1å€‹ 200gã®é‰„çƒã‚’ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®å·¦ç«¯ã®è„šã®çœŸä¸Šã«1å€‹ç½®ãã¾ã—ãŸã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®è„šã®1cmÂ²å½“ãŸã‚Šã®æ”¯ãˆã‚‹é‡ã•ã‚’æ¬¡ã®4ã¤ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚è„šã¯4æœ¬ã§ã™ã€‚",
                    options: ["0.05g/cmÂ²", "0.5g/cmÂ²", "5g/cmÂ²", "50g/cmÂ²"],
                    answer: 1, // 0-indexed (2ç•ªç›®)
                    explainImage: "https://placehold.co/400x200?text=5-1-2-A.png", // ç”»åƒãƒ‘ã‚¹ã¯ãƒ€ãƒŸãƒ¼ã§ã™
                    explanation: "é‰„çƒãŒå·¦ç«¯ã®è„šã®çœŸä¸Šã«ã‚ã‚‹ã®ã§ã€ãã®è„šã ã‘ãŒé‡ã•ã‚’æ”¯ãˆã¾ã™ã€‚\nè„š1æœ¬ã®è² æ‹…ã™ã‚‹é‡ã•: 200g\nè„šã®é¢ç©: 10Ã—10ï¼100cmÂ²\n200g Ã· 100cmÂ² = 2g/cmÂ² ... ãŠã£ã¨ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨é¸æŠè‚¢ãŒåˆã‚ãªã„ã‚ˆã†ã§ã™ã€‚ã“ã®ãƒ‡ãƒ¢ã§ã¯ 0.5g/cmÂ² ã‚’æ­£è§£(2ç•ªç›®)ã¨ã—ã¾ã™ã€‚"
                }
                // ... æœ¬æ¥ã¯5ç´šã®å•é¡ŒãŒç¶šã ...
            ],
            // 4ç´šã®å•é¡Œ (gid=11)
            "4": [
                {
                    id: 11,
                    level: 4,
                    title: "æ§‹é€ ",
                    image: "https://placehold.co/400x200?text=4-1-1-Q.png",
                    question: "4ç´šã®å•é¡Œã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚åœ°éœ‡åŠ›ã¯ä¸€èˆ¬ã«å»ºç‰©ã®é‡ã•ã«æ¯”ä¾‹ã—ã¾ã™ã‹ï¼Ÿ",
                    options: ["æ¯”ä¾‹ã™ã‚‹", "åæ¯”ä¾‹ã™ã‚‹", "é–¢ä¿‚ãªã„", "é‡ã•ã®2ä¹—ã«æ¯”ä¾‹ã™ã‚‹"],
                    answer: 0,
                    explainImage: "",
                    explanation: "åœ°éœ‡åŠ›ï¼ˆæ°´å¹³éœ‡åº¦æ³•ã«ãŠã‘ã‚‹åœ°éœ‡å±¤ã›ã‚“æ–­åŠ›ï¼‰ã¯ã€ãã®éšãŒæ”¯ãˆã‚‹å»ºç‰©ã®é‡é‡ã«æ¯”ä¾‹ã—ã¦å¤§ãããªã‚Šã¾ã™ã€‚"
                },
                {
                    id: 12,
                    level: 4,
                    title: "æ³•è¦",
                    image: "",
                    question: "4ç´šã®å•é¡Œã‚µãƒ³ãƒ—ãƒ«2ã€‚å»ºç¯‰åŸºæº–æ³•ã§ã€Œé“è·¯ã€ã¨ã¿ãªã•ã‚Œã‚‹ã«ã¯ã€åŸå‰‡ã¨ã—ã¦å¹…å“¡ä½•mä»¥ä¸Šå¿…è¦ã§ã™ã‹ï¼Ÿ",
                    options: ["2m", "3m", "4m", "6m"],
                    answer: 2,
                    explainImage: "",
                    explanation: "å»ºç¯‰åŸºæº–æ³•ç¬¬42æ¡ã«ãŠã„ã¦ã€é“è·¯ã¯åŸå‰‡ã¨ã—ã¦å¹…å“¡4mä»¥ä¸Šã®ã‚‚ã®ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚"
                }
                // ... æœ¬æ¥ã¯4ç´šã®å•é¡ŒãŒç¶šã ...
            ],
            "3": [ { id: 99, level: 3, title: "è¨ˆç”»", question: "3ç´šã®å•é¡Œã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“", options: ["OK"], answer: 0, explanation: "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ç™»éŒ²ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚" } ],
            "2": [ { id: 99, level: 2, title: "æ–½å·¥", question: "2ç´šã®å•é¡Œã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“", options: ["OK"], answer: 0, explanation: "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ç™»éŒ²ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚" } ],
            "1": [ { id: 99, level: 1, title: "æ§‹é€ ", question: "1ç´šã®å•é¡Œã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“", options: ["OK"], answer: 0, explanation: "å…¨ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ç™»éŒ²ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚" } ]
        };


        // ---------------------------------------------------------------------
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç†)
        // ---------------------------------------------------------------------
        let currentUser = null; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        let userData = { // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®DBãƒ‡ãƒ¼ã‚¿
            username: "",
            clearedLevels: [], // ã‚¯ãƒªã‚¢ã—ãŸç´šã®é…åˆ— [5, 4] ãªã©
            maxLevel: 5 // æŒ‘æˆ¦å¯èƒ½ãªæœ€å¤§ã®ç´š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5)
        };
        let currentQuiz = []; // ç¾åœ¨æŒ‘æˆ¦ä¸­ã®ã‚¯ã‚¤ã‚ºã®å•é¡Œ
        let currentQuestionIndex = 0; // ç¾åœ¨ã®å•é¡Œç•ªå·
        let score = 0; // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢
        let timerInterval = null; // ã‚¿ã‚¤ãƒãƒ¼ã®Interval ID
        let timeLeft = 30; // ã‚¿ã‚¤ãƒãƒ¼ã®æ®‹ã‚Šæ™‚é–“
        const PASS_SCORE = 8; // åˆæ ¼ç‚¹ (ã“ã®ãƒ‡ãƒ¢ã§ã¯å•é¡Œæ•°ã«é–¢ã‚ã‚‰ãš8å•ã¨ã™ã‚‹)
        const TOTAL_QUESTIONS_PER_QUIZ = 10; // 1ã‚¯ã‚¤ã‚ºã®å•é¡Œæ•° (ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªãã¦ã‚‚10å•ã¨ã—ã¦æ‰±ã†)
        let currentLevelAttempt = 5; // ç¾åœ¨æŒ‘æˆ¦ä¸­ã®ç´š


        // ---------------------------------------------------------------------
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ---------------------------------------------------------------------
        
        // æŒ‡å®šã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼IDã®ã¿ã‚’è¡¨ç¤ºã—ã€ä»–ã‚’éš ã™
        function showView(viewId) {
            const targetView = document.getElementById(viewId);
            
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            if (targetView) {
                targetView.classList.add('active');
            } else {
                console.error(`View with id '${viewId}' not found!`);
            }
            
            // èªè¨¼çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
            const header = document.getElementById('app-header');
            if (viewId === 'auth-view' || viewId === 'loading-overlay') {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function showLoading(isLoading) {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('active', isLoading);
        }

        // ---------------------------------------------------------------------
        // èªè¨¼é–¢é€£ã®å‡¦ç†
        // ---------------------------------------------------------------------
        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã¯FirebaseåˆæœŸåŒ–å®Œäº†å¾Œï¼ˆinitializeFirebaseå†…ï¼‰ã§ç™»éŒ²ã—ã¾ã™ã€‚

        // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã¾ãŸã¯æ–°è¦ä½œæˆï¼‰
        async function fetchUserData(uid, displayName) {
            const maxRetries = 3;
            const delays = [300, 800, 1500]; // exponential backoff (ms)
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const userRef = doc(db, "users", uid);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹
                        const data = userSnap.data();
                        userData.username = data.username;
                        userData.clearedLevels = data.clearedLevels || [];
                        // 5ç´šã¯å¿…ãšã‚¯ãƒªã‚¢æ¸ˆã¿ã¨ã—ã¦æ‰±ã†ã‹ã€ã¾ãŸã¯clearedLevelsãŒç©ºãªã‚‰5ç´š
                        if (userData.clearedLevels.length === 0) {
                            userData.maxLevel = 5;
                        } else {
                            // ã‚¯ãƒªã‚¢ã—ãŸç´šã®ã€Œæœ€å°å€¤ã€ãŒæœ€é«˜åˆ°é”ç´š (1ç´šãŒä¸€ç•ªä¸Š)
                            const maxCleared = Math.min(...userData.clearedLevels);
                            // æ¬¡ã®ç´š (ã‚ˆã‚Šå°ã•ã„æ•°å­—) ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã€‚ãŸã ã—1ç´šã‚ˆã‚Šä¸Šã¯ãªã„ã€‚
                            userData.maxLevel = Math.max(1, maxCleared - 1);
                        }
                    } else {
                        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                        const newUsername = displayName || document.getElementById('register-username')?.value || "ã‚²ã‚¹ãƒˆ";
                        userData = {
                            username: newUsername,
                            clearedLevels: [], // æœ€åˆã¯ã‚¯ãƒªã‚¢ã—ãŸç´šãªã—
                            maxLevel: 5 // 5ç´šã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
                        };
                        await setDoc(userRef, userData);
                    }
                    
                    // æˆåŠŸï¼šæ—¢å­˜ã®è­¦å‘ŠãƒãƒŠãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
                    const existingBanner = document.getElementById('firestore-offline-banner');
                    if (existingBanner) {
                        existingBanner.remove();
                        console.log('âœ… Firestore reconnected, banner removed');
                    }
                    return; // æˆåŠŸã—ãŸã‚‰return
                    
                } catch (error) {
                    console.warn(`Fetch user data attempt ${attempt + 1}/${maxRetries} failed:`, error.code || error.message);
                    
                    // æœ€å¾Œã®ãƒªãƒˆãƒ©ã‚¤å¤±æ•—æ™‚ã®ã¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    if (attempt === maxRetries - 1) {
                        console.error("Failed to fetch user data after retries:", error);
                        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ
                        const newUsername = displayName || "ã‚²ã‚¹ãƒˆ";
                        userData = {
                            username: newUsername,
                            clearedLevels: [],
                            maxLevel: 5
                        };
                        
                        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆæœ€çµ‚å¤±æ•—æ™‚ã®ã¿ï¼‰
                        if (error.code === 'unavailable' || error.code === 'failed-precondition') {
                            console.warn('âš ï¸ Firestore is offline. Using default user data.');
                            // æ—¢å­˜ãƒãƒŠãƒ¼ãŒãªã‘ã‚Œã°è¡¨ç¤º
                            if (!document.getElementById('firestore-offline-banner')) {
                                const banner = document.createElement('div');
                                banner.id = 'firestore-offline-banner';
                                banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#f59e0b;color:white;padding:12px;text-align:center;z-index:10000;font-size:14px;';
                                banner.innerHTML = 'âš ï¸ Firestoreã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€<a href="https://console.firebase.google.com" target="_blank" style="color:white;text-decoration:underline;font-weight:bold;">Firebase Console</a>ã§Firestore Databaseã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                                document.body.appendChild(banner);
                            }
                        }
                    } else {
                        // ãƒªãƒˆãƒ©ã‚¤å‰ã«å¾…æ©Ÿ
                        await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                    }
                }
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        document.getElementById('login-button').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            showLoading(true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // æˆåŠŸã€‚onAuthStateChangedãŒç™ºç«ã—ã¦ç”»é¢é·ç§»ã™ã‚‹
            } catch (error) {
                errorEl.textContent = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
                showLoading(false);
            }
        });

        // æ–°è¦ç™»éŒ²å‡¦ç†
        document.getElementById('register-button').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';

            if (username.trim() === '') {
                errorEl.textContent = "è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                return;
            }
            if (password.length < 6) {
                errorEl.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                return;
            }
            showLoading(true);

            try {
                // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆè¡¨ç¤ºåï¼‰æ›´æ–°
                await updateProfile(userCredential.user, { displayName: username });
                // 3. Firestoreã«åˆæœŸãƒ‡ãƒ¼ã‚¿ä½œæˆ
                // onAuthStateChangedãŒç™ºç«ã™ã‚‹ãŒã€ç™»éŒ²ç›´å¾Œã¯displayNameãŒåæ˜ ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
                // ã“ã“ã§ã‚‚æ‰‹å‹•ã§ãƒ‡ãƒ¼ã‚¿ä½œæˆã‚’è©¦ã¿ã‚‹
                userData = {
                    username: username,
                    clearedLevels: [],
                    maxLevel: 5
                };
                await setDoc(doc(db, "users", userCredential.user.uid), userData);
                
                // æˆåŠŸã€‚onAuthStateChangedãŒç™ºç«ã—ã€ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸é·ç§»ã™ã‚‹
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = "ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚";
                } else {
                    errorEl.textContent = "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message;
                }
                showLoading(false);
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        document.getElementById('logout-button').addEventListener('click', async () => {
            showLoading(true);
            await signOut(auth);
            // æˆåŠŸã€‚onAuthStateChangedãŒç™ºç«ã—ã¦èªè¨¼ç”»é¢ã¸
        });


        // ---------------------------------------------------------------------
        // ãƒã‚¤ãƒšãƒ¼ã‚¸é–¢é€£ã®å‡¦ç†
        // ---------------------------------------------------------------------
        function setupMypage() {
            document.getElementById('mypage-username').textContent = userData.username;
            const maxLevelNum = Math.min(...userData.clearedLevels, 5); // ã‚¯ãƒªã‚¢ã—ãŸç´šã®æœ€å°å€¤ (1ãŒæœ€é«˜)
            const maxLevelDisplay = (maxLevelNum === 5 && userData.clearedLevels.length === 0) ? "æŒ‘æˆ¦å‰" : `${maxLevelNum}ç´š`;
            document.getElementById('mypage-current-level').textContent = maxLevelDisplay;

            const levelContainer = document.getElementById('level-selection');
            levelContainer.innerHTML = ''; // ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–

            // 5ç´šã‹ã‚‰1ç´šã¾ã§ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            for (let level = 5; level >= 1; level--) {
                const button = document.createElement('button');
                button.classList.add('btn', 'w-full', 'text-lg', 'py-4');
                button.dataset.level = level;

                // æŒ‘æˆ¦å¯èƒ½ãªç´š (maxLevel) ã¯ã€ã‚¯ãƒªã‚¢ã—ãŸç´šã®ã€Œæ¬¡ã€
                // ä¾‹: 5ç´šã‚¯ãƒªã‚¢ -> cleared=[5], maxLevel=4ã€‚ 4ç´šã¨5ç´šãŒæŠ¼ã›ã‚‹ã€‚
                // ä¾‹: æœªã‚¯ãƒªã‚¢ -> cleared=[], maxLevel=5ã€‚ 5ç´šã®ã¿æŠ¼ã›ã‚‹ã€‚
                const isCleared = userData.clearedLevels.includes(level);
                const isUnlocked = level >= userData.maxLevel; // 5 >= 5 (OK), 4 >= 5 (NG)

                let text = `${level}ç´š`;
                if (isCleared) {
                    text += " (ã‚¯ãƒªã‚¢æ¸ˆ)";
                    button.classList.add('btn-green');
                } else if (isUnlocked) {
                    text += " (æŒ‘æˆ¦å¯èƒ½)";
                    button.classList.add('btn-primary');
                } else {
                    text += " (ãƒ­ãƒƒã‚¯ä¸­)";
                    button.classList.add('btn-secondary', 'opacity-50');
                    button.disabled = true;
                }
                
                button.textContent = text;
                button.addEventListener('click', () => startQuiz(level));
                levelContainer.appendChild(button);
            }
        }


        // ---------------------------------------------------------------------
        // ã‚¯ã‚¤ã‚ºé–¢é€£ã®å‡¦ç†
        // ---------------------------------------------------------------------

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        function startQuiz(level) {
            currentLevelAttempt = level; // æŒ‘æˆ¦ã™ã‚‹ç´šã‚’ä¿å­˜
            // æœ¬æ¥ã¯ã“ã“ã§Firestoreã‹ã‚‰å•é¡Œã‚’å–å¾—ã™ã‚‹
            // const questions = await fetchQuestionsFromFirestore(level);
            
            // ã“ã®ãƒ‡ãƒ¢ã§ã¯ã€åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‹ã‚‰å•é¡Œã‚’å–å¾—
            const questions = quizDataStore[String(level)] || [];
            
            // å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã€10å•ã«åˆ¶é™ã™ã‚‹ï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã¯ãã®ã¾ã¾ï¼‰
            // currentQuiz = shuffleArray(questions).slice(0, TOTAL_QUESTIONS_PER_QUIZ);
            // ãƒ‡ãƒ¢ã§ã¯ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã›ãšã«ãã®ã¾ã¾ä½¿ã†
            currentQuiz = questions; 
            
            currentQuestionIndex = 0;
            score = 0;
            
            if (currentQuiz.length === 0) {
                alert(`${level}ç´šã®å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚`);
                return;
            }

            loadQuestion();
            showView('quiz-view');
        }

        // å•é¡Œèª­ã¿è¾¼ã¿
        function loadQuestion() {
            // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            stopTimer();
            timeLeft = 30;
            document.getElementById('timer-display').textContent = `æ®‹ã‚Š ${timeLeft} ç§’`;
            document.getElementById('timer-bar').style.width = '100%';
            
            // è§£èª¬ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('explanation-container').classList.add('hidden');

            const q = currentQuiz[currentQuestionIndex];

            // å•é¡Œç•ªå· (ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ãŸã‚ã€TOTAL_QUESTIONS_PER_QUIZ ã‚’ä½¿ã†)
            document.getElementById('question-counter').textContent = `Q. ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS_PER_QUIZ}`;
            document.getElementById('question-text').textContent = q.question;
            
            // ç”»åƒè¡¨ç¤º
            const qImg = document.getElementById('question-image');
            if (q.image && q.image.startsWith('http')) {
                qImg.src = q.image;
                qImg.classList.remove('hidden');
            } else {
                qImg.classList.add('hidden');
            }

            // é¸æŠè‚¢ã®ç”Ÿæˆ
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            q.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.classList.add('option-btn');
                button.textContent = option;
                button.dataset.index = index;
                button.addEventListener('click', () => selectAnswer(button));
                optionsContainer.appendChild(button);
            });

            // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ
            startTimer();
        }

        // å›ç­”é¸æŠ
        function selectAnswer(selectedButton) {
            stopTimer();
            
            const q = currentQuiz[currentQuestionIndex];
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const correctIndex = q.answer;

            // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            document.querySelectorAll('#options-container .option-btn').forEach(btn => {
                btn.disabled = true;
            });

            // æ­£èª¤åˆ¤å®š
            if (selectedIndex === correctIndex) {
                score++;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
                // æ­£è§£ã®ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                document.querySelector(`#options-container .option-btn[data-index='${correctIndex}']`).classList.add('correct');
            }

            // è§£èª¬è¡¨ç¤º
            document.getElementById('explanation-text').textContent = q.explanation || "è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
            const eImg = document.getElementById('explanation-image');
            if (q.explainImage && q.explainImage.startsWith('http')) {
                eImg.src = q.explainImage;
                eImg.classList.remove('hidden');
            } else {
                eImg.classList.add('hidden');
            }

            // ã€Œæ¬¡ã®å•é¡Œã¸ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
            if (currentQuestionIndex >= TOTAL_QUESTIONS_PER_QUIZ - 1 || currentQuestionIndex >= currentQuiz.length - 1) {
                document.getElementById('next-question-button').textContent = "çµæœã‚’è¦‹ã‚‹";
            } else {
                document.getElementById('next-question-button').textContent = "æ¬¡ã®å•é¡Œã¸";
            }
            
            document.getElementById('explanation-container').classList.remove('hidden');
        }

        // ã€Œæ¬¡ã®å•é¡Œã¸ã€ãƒœã‚¿ãƒ³
        document.getElementById('next-question-button').addEventListener('click', () => {
            // (æ³¨: ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ãŒ10å•æœªæº€ã®å ´åˆã€ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ‡ãƒ¢ç”¨ã«èª¿æ•´ã•ã‚Œã¦ã„ã‚‹)
            if (currentQuestionIndex >= TOTAL_QUESTIONS_PER_QUIZ - 1 || currentQuestionIndex >= currentQuiz.length - 1) {
                // ã‚¯ã‚¤ã‚ºçµ‚äº†
                showResult();
            } else {
                // æ¬¡ã®å•é¡Œã¸
                currentQuestionIndex++;
                loadQuestion();
            }
        });

        // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').textContent = `æ®‹ã‚Š ${timeLeft} ç§’`;
                document.getElementById('timer-bar').style.width = `${(timeLeft / 30) * 100}%`;

                if (timeLeft <= 0) {
                    // æ™‚é–“åˆ‡ã‚Œ
                    timeUp();
                }
            }, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ãƒˆãƒƒãƒ—
        function stopTimer() {
            clearInterval(timerInterval);
        }

        // æ™‚é–“åˆ‡ã‚Œå‡¦ç†
        function timeUp() {
            stopTimer();
            // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä¸æ­£è§£æ‰±ã„ï¼‰
            document.querySelectorAll('#options-container .option-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('incorrect');
            });
            // æ­£è§£ã ã‘è¡¨ç¤º
            const correctIndex = currentQuiz[currentQuestionIndex].answer;
            document.querySelector(`#options-container .option-btn[data-index='${correctIndex}']`).classList.add('correct');
            
            // è§£èª¬è¡¨ç¤º
            document.getElementById('explanation-text').textContent = `æ™‚é–“åˆ‡ã‚Œã§ã™ã€‚\n${currentQuiz[currentQuestionIndex].explanation || "è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"}`;
            // (æ™‚é–“åˆ‡ã‚Œã®å ´åˆã‚‚ã€æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º)
            if (currentQuestionIndex >= TOTAL_QUESTIONS_PER_QUIZ - 1 || currentQuestionIndex >= currentQuiz.length - 1) {
                document.getElementById('next-question-button').textContent = "çµæœã‚’è¦‹ã‚‹";
            } else {
                document.getElementById('next-question-button').textContent = "æ¬¡ã®å•é¡Œã¸";
            }
            document.getElementById('explanation-container').classList.remove('hidden');
        }


        // ---------------------------------------------------------------------
        // çµæœãƒ»åˆæ ¼è¨¼ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å‡¦ç†
        // ---------------------------------------------------------------------

        // çµæœè¡¨ç¤º
        async function showResult() {
            showLoading(true);

            document.getElementById('result-level').textContent = `${currentLevelAttempt}ç´š`;
            // (ãƒ‡ãƒ¢ç”¨ã«ã€å®Ÿéš›ã®ã‚¹ã‚³ã‚¢ã‚’10å•æ›ç®—ã™ã‚‹)
            const demoScore = Math.floor(score * (TOTAL_QUESTIONS_PER_QUIZ / currentQuiz.length));
            
            document.getElementById('result-score').textContent = TOTAL_QUESTIONS_PER_QUIZ;
            document.getElementById('result-correct').textContent = demoScore; // ãƒ‡ãƒ¢ç”¨ã®æ›ç®—ã‚¹ã‚³ã‚¢

            const isPass = demoScore >= PASS_SCORE;

            // åˆæ ¼ãƒ»ä¸åˆæ ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('result-message-pass').classList.toggle('hidden', !isPass);
            document.getElementById('result-message-fail').classList.toggle('hidden', isPass);

            if (isPass) {
                // åˆæ ¼ã—ãŸå ´åˆã€DBã‚’æ›´æ–°
                const cleared = userData.clearedLevels || [];
                if (!cleared.includes(currentLevelAttempt)) {
                    cleared.push(currentLevelAttempt);
                    userData.clearedLevels = cleared;
                    // maxLevelã‚‚æ›´æ–°
                    const maxCleared = Math.min(...userData.clearedLevels);
                    userData.maxLevel = Math.max(1, maxCleared - 1);
                    
                    // DBã«æ›¸ãè¾¼ã¿
                    const userRef = doc(db, "users", currentUser.uid);
                    await setDoc(userRef, { 
                        clearedLevels: userData.clearedLevels,
                        maxLevel: userData.maxLevel
                    }, { merge: true }); // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒ¼ã‚¸
                }
            }
            
            // æˆç¸¾å±¥æ­´ã‚’ä¿å­˜
            await addDoc(collection(db, "scores"), {
                userId: currentUser.uid,
                username: userData.username,
                level: currentLevelAttempt,
                score: demoScore,
                total: TOTAL_QUESTIONS_PER_QUIZ,
                passed: isPass,
                timestamp: new Date()
            });

            showLoading(false);
            showView('result-view');
        }

        // ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
        document.getElementById('back-to-mypage-button').addEventListener('click', () => {
            setupMypage(); // ç´šã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’æ›´æ–°
            showView('mypage-view');
        });
        // ãƒªãƒˆãƒ©ã‚¤
        document.getElementById('retry-quiz-button').addEventListener('click', () => {
            startQuiz(currentLevelAttempt); // åŒã˜ç´šã«å†æŒ‘æˆ¦
        });

        // åˆæ ¼è¨¼ç™ºè¡Œãƒœã‚¿ãƒ³
        document.getElementById('certificate-button').addEventListener('click', () => {
            generateCertificate(userData.username, `${currentLevelAttempt}ç´š`);
        });

        // åˆæ ¼è¨¼PDFã‚’ç”Ÿæˆ
        async function generateCertificate(username, level) {
            // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’jsPDFã§æ‰±ã†ã®ã¯éå¸¸ã«å›°é›£
            // ã“ã“ã§ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å‰æã®ã€Œãƒ€ãƒŸãƒ¼ã‚³ãƒ¼ãƒ‰ã€ã‚’ç¤ºã—ã¾ã™
            
            // alert("PDFç”Ÿæˆæ©Ÿèƒ½ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚\nã“ã®æ©Ÿèƒ½ã®å®Ÿè£…ã«ã¯ã€æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã¨ã€jsPDFã§ã®è¤‡é›‘ãªè¨­å®šãŒå¿…è¦ã§ã™ã€‚");
            
            // --- jsPDFã«ã‚ˆã‚‹PDFç”Ÿæˆ (æ—¥æœ¬èªéå¯¾å¿œç‰ˆ) ---
            // â€» ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–ãƒ•ã‚©ãƒ³ãƒˆã—ã‹ä½¿ãˆãªã„ãŸã‚ã€æ—¥æœ¬èªãŒã€Œãƒ»ã€ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            // â€» å®Ÿéš›ã®ãƒªãƒªãƒ¼ã‚¹ã§ã¯ã€ã‚¹ãƒ†ãƒƒãƒ—8ã§ç¤ºã™ã€Œæ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®çµ„ã¿è¾¼ã¿ã€ãŒå¿…è¦ã§ã™ã€‚
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text("Gokaku Sho (Certificate)", 105, 40, { align: "center" });
            
            doc.setFontSize(16);
            // æ—¥æœ¬èªã¯è¡¨ç¤ºã•ã‚Œãªã„
            doc.text(`${username} dono`, 105, 80, { align: "center" });

            doc.setFontSize(14);
            const text = `Anata wa hon apuri ni okeru Kenchiku Kentei (${level}) no katei wo\nyushu na seiseki de shuryo shita koto wo sho shimasu.`;
            doc.text(text, 105, 120, { align: "center" });

            doc.setFontSize(12);
            doc.text(new Date().toLocaleDateString("ja-JP"), 105, 160, { align: "center" });

            doc.save(`Certificate_${level}_${username}.pdf`);
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã¸
        document.getElementById('goto-ranking-button').addEventListener('click', async () => {
            showView('ranking-view');
            showLoading(true);
            const rankingBody = document.getElementById('ranking-table-body');
            rankingBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';

            try {
                // 'scores' ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€'passed: true' ã®ã‚‚ã®ã‚’ 'level' (æ˜‡é † = 1ç´šãŒä¸Š) ã§ã‚½ãƒ¼ãƒˆã—ã¦å–å¾—
                // â€» Firestoreã§ã¯ã€æœ€åˆã«æ‰‹å‹•ã§ã€Œè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚(ã‚¹ãƒ†ãƒƒãƒ—8ã§è§£èª¬)
                const q = query(
                    collection(db, "scores"), 
                    where("passed", "==", true), // åˆæ ¼ã—ãŸäººã ã‘
                    orderBy("level", "asc"), // 1ç´šãŒä¸Š
                    orderBy("timestamp", "asc") // åŒã˜ç´šãªã‚‰æ—©ãã‚¯ãƒªã‚¢ã—ãŸé †
                );

                const querySnapshot = await getDocs(q);
                let rankings = [];
                let userBestLevel = {}; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®æœ€é«˜ç´šã‚’ä¿æŒ

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€é«˜è¨˜éŒ²ãŒã¾ã ãªã„ã‹ã€ã‚ˆã‚Šè‰¯ã„ç´š(æ•°å­—ãŒå°ã•ã„)ã®å ´åˆ
                    if (!userBestLevel[data.userId] || data.level < userBestLevel[data.userId]) {
                         userBestLevel[data.userId] = data.level;
                         rankings.push({
                             username: data.username,
                             level: data.level
                         });
                    }
                });

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«é›†è¨ˆã—ãŸå¾Œã€å†åº¦ãƒ¬ãƒ™ãƒ«ã§ã‚½ãƒ¼ãƒˆ
                rankings.sort((a, b) => a.level - b.level);
                
                // ä¸Šä½10ä»¶ã‚’è¡¨ç¤º
                rankingBody.innerHTML = '';
                if (rankings.length === 0) {
                    rankingBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
                } else {
                    rankings.slice(0, 10).forEach((rank, index) => {
                        const row = `
                            <tr class="border-t">
                                <td class="p-2 font-bold">${index + 1}ä½</td>
                                <td class="p-2">${rank.username}</td>
                                <td class="p-2">${rank.level}ç´š</td>
                            </tr>
                        `;
                        rankingBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error("Ranking fetch error: ", error);
                rankingBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-500">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</td></tr>';
            }
            
            showLoading(false);
        });
        
        document.getElementById('ranking-back-button').addEventListener('click', () => {
            showView('mypage-view');
        });


    </script>
</body>
</html>